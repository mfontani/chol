makefile_gen: main.c foo_kvp.c foo_kvp.h
	gcc -o makefile_gen main.c foo_kvp.c

foo_kvp.h: Makefile ../../dyn_kvp.h
	rm -f $@
	printf '// Automatically generated by %s.\n' "$^" > $@
	printf '// Generated on %s\n' "$$(date)" >> $@
	printf '#ifndef FOO_KVP_H_\n#define FOO_KVP_H_\n' >> $@
	gcc -E -P -CC -D DYN_KVP_VALUE_TYPE='struct foo' -D DYN_KVP_TYPE_NAME=foo_kvp ../../dyn_kvp.h | perl -0777 -pe's,/[*].*?[*]/,,gs' | grep -v -e '^\s*$$' >> $@
	printf '#endif\n' >> $@
	chmod -w $@

foo_kvp.c: Makefile foo_kvp.h ../../dyn_kvp.h
	rm -f $@
	printf '// Automatically generated by %s.\n' "$^" > $@
	printf '// Generated on %s\n' "$$(date)" >> $@
	printf '#include "inc.h"\n' >> $@
	printf '#include "foo_kvp.h"\n' >> $@
	gcc -E -P -CC -D DYN_KVP_VALUE_TYPE='struct foo' -D DYN_KVP_TYPE_NAME=foo_kvp -D DYN_KVP_IMPLEMENTATION ../../dyn_kvp.h | perl -0777 -pe's,/[*].*?[*]/,,gs' | grep -v -e '^\s*$$' >> $@
	chmod -w $@
